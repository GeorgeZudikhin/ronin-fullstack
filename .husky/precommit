#!/bin/bash

set -e

REPO_ROOT=$(git rev-parse --show-toplevel)
STAGED_FILES=$(git diff --cached --name-only)
HAS_ERRORS=0

#######################
# Check Frontend
#######################
FRONTEND_DIR="ronin-frontend"
if echo "$STAGED_FILES" | grep -q "^$FRONTEND_DIR/"; then
  echo "ğŸš€ Changes detected in $FRONTEND_DIR"
  
  echo "ğŸ” Linting frontend..."
  if cd "$REPO_ROOT/$FRONTEND_DIR" && npm run lint; then
    echo "âœ… Frontend lint passed!"
  else
    echo "âŒ Frontend lint failed!"
    HAS_ERRORS=1
  fi

  echo "ğŸ” Running secret checks..."
  if cd "$REPO_ROOT/$FRONTEND_DIR" && git secrets --scan; then
    echo "âœ… Secret checks passed!"
  else
    echo "âŒ Secrets check failed!"
    HAS_ERRORS=1
  fi

  echo "ğŸ§ª Running frontend tests..."
  if cd "$REPO_ROOT/$FRONTEND_DIR" && npx vitest run; then
    echo "âœ… Frontend tests passed!"
  else
    echo "âŒ Frontend tests failed!"
    HAS_ERRORS=1
  fi
else
  echo "âœ… No frontend changes detected. Skipping frontend checks."
fi

#######################
# Check Backend
#######################
BACKEND_DIR="ronin-backend"
if echo "$STAGED_FILES" | grep -q "^$BACKEND_DIR/"; then
  echo "ğŸš€ Changes detected in $BACKEND_DIR"

  echo "ğŸ” Running Java checkstyle..."
  if cd "$REPO_ROOT/$BACKEND_DIR" && mvn checkstyle:check; then
    echo "âœ… Java checkstyle passed!"
  else
    echo "âŒ Java checkstyle failed!"
    HAS_ERRORS=1
  fi

  echo "ğŸ§ª Running backend tests..."
  if cd $BACKEND_DIR && mvn test; then
    echo "âœ… Backend tests passed!"
  else
    echo "âŒ Backend tests failed!"
    HAS_ERRORS=1
  fi

else
  echo "âœ… No backend changes detected. Skipping backend checks."
fi

#######################
# Final Gate
#######################
if [ "$HAS_ERRORS" -ne 0 ]; then
  echo "ğŸš« Commit aborted due to errors above."
  exit 1
else
  echo "âœ… All checks passed. Proceeding with commit."
  exit 0
fi
